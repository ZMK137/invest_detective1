<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invest Detective Terminal</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <style>
        /* Minimalne poprawki dla struktury dashboardu */
        #main-content { transition: margin-left .3s; padding: 20px; padding-top: 80px; }
        .view-section { display: none; }
        .sidebar { transition: 0.3s; }
    </style>
</head>
<body>

<div id="mySidebar" class="sidebar">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    <div class="ps-3 mb-4 mt-2">
        <span class="badge bg-secondary">PLAN FREE</span>
        <div class="small text-dim mt-1">Zużyto: {{ checks_used }}/500</div>
    </div>
    <a onclick="showSection('dashboard')" id="link-dashboard" class="active"><i class="bi bi-grid-1x2 me-2"></i> Dashboard</a>
    <a onclick="showSection('dcf')" id="link-dcf"><i class="bi bi-calculator me-2"></i> Raport DCF</a>
    <a onclick="showSection('fundamental')" id="link-fundamental"><i class="bi bi-bar-chart-steps me-2"></i> Fundamenty</a>
    <a onclick="showSection('indicators')" id="link-indicators"><i class="bi bi-bullseye me-2"></i> Wskaźniki</a>
    <a onclick="showSection('charts')" id="link-charts"><i class="bi bi-graph-up me-2"></i> Wykresy</a>
    <hr class="border-secondary mx-3">
    <a onclick="showSection('subscription')" id="link-subscription" class="text-warning"><i class="bi bi-star-fill me-2"></i> Subskrypcja</a>
    <a onclick="showSection('login')" id="link-login"><i class="bi bi-person-circle me-2"></i> Zaloguj się</a>
</div>

<button class="open-btn" onclick="openNav()"><i class="bi bi-list"></i></button>

<div id="main-content">
    <div class="container-fluid px-3 mb-4">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
            <div class="d-flex align-items-center">
                <div class="main-logo">INVEST<span class="logo-blue">DETECTIVE</span></div>
            </div>
           <div class="search-container-nav flex-grow-1" style="max-width: 400px; position: relative;">
                <form action="/" method="POST" id="navSearchForm" class="d-flex gap-2">
                    <input type="text"
                           name="ticker"
                           id="navTickerInput"
                           class="form-control form-control-dark"
                           placeholder="TICKER (np. CDR)..."
                           autocomplete="off"
                           required>
                    <button type="submit" class="btn btn-primary">SZUKAJ</button>
                </form>
                <div id="navSuggestionsBox" class="suggestions-box"></div>
            </div>
        </div>
    </div>

    {% if limit_reached %}
    <div class="container-fluid px-3">
        <div class="alert alert-danger text-center py-5" style="background: var(--card-color); border: 1px solid var(--accent-red); color: white;">
            <h1><i class="bi bi-lock-fill text-danger"></i></h1>
            <h2>Limit Dzienny Osiągnięty</h2>
            <p class="lead mb-4 text-dim">Wykorzystałeś 500 darmowych analiz dzisiaj.</p>
            <button onclick="showSection('subscription')" class="btn btn-primary btn-lg">Zobacz Ofertę</button>
        </div>
    </div>
    {% endif %}

    {% if result and not limit_reached %}
    <div class="container-fluid px-3">

        <div id="view-dashboard" class="view-section" style="display: block;">
            <div class="row g-3">
                <div class="col-lg-9">
                    <div class="dashboard-card p-0 overflow-hidden" style="height: 500px;">
                        <div id="tradingview_chart" style="height:100%; width:100%"></div>
                        <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
                        <script type="text/javascript">
                        new TradingView.widget({
                            "autosize": true,
                            "symbol": "{% if '.' in result.ticker %}GPW:{{ result.ticker.split('.')[0] }}{% else %}NASDAQ:{{ result.ticker }}{% endif %}",
                            "interval": "D",
                            "timezone": "Europe/Warsaw",
                            "theme": "dark",
                            "container_id": "tradingview_chart"
                        });
                        </script>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="dashboard-card text-center mb-3">
                        <div class="metric-label-big">CENA RYNKOWA</div>
                        <div class="metric-val-big">{{ result.current_price }} PLN</div>
                    </div>
                    <div class="dashboard-card text-center mb-3">
                        <div class="metric-label-big">KAPITALIZACJA</div>
                        <div class="metric-val-big text-white">{{ "{:,.2f}".format(result.mcap / 1000000000) }} mld</div>
                    </div>
                    <div class="dashboard-card text-center">
                        <div class="metric-label-big">RYZYKO (ML)</div>
                        <div class="metric-val-big {{ 'val-bad' if result.ml_prob > 50 else 'val-good' }}">{{ "{:.1f}".format(result.ml_prob) }}%</div>
                    </div>
                    {% if result.dcf %}
                    <div class="dashboard-card text-center mt-3" style="border-top: 2px solid var(--accent-blue)">
                        <div class="metric-label-big text-blue">FAIR VALUE (DCF)</div>
                        <div class="metric-val-big">{{ result.dcf.fair_value }}</div>
                        <div class="small mt-1 {{ 'val-good' if result.dcf.fair_value > result.current_price else 'val-bad' }}">
                            {{ "NIEDOWARTOŚCIOWANA" if result.dcf.fair_value > result.current_price else "PRZEWARTOŚCIOWANA" }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div id="view-dcf" class="view-section">
            <h5 class="text-white mb-4">Raport Wyceny DCF</h5>
            {% if result.dcf %}
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="dashboard-card">
                        <h6 class="text-secondary mb-4">ZAŁOŻENIA MODELU</h6>
                        <ul class="list-unstyled">
                            <li class="d-flex justify-content-between mb-2">
                                <span>Free Cash Flow: <i class="bi bi-info-circle info-icon ms-1" data-bs-toggle="tooltip" title="Wolne przepływy pieniężne (OCF - CapEx). Gotówka dostępna dla właścicieli."></i></span> 
                                <span class="font-monospace fw-bold">{{ "{:,.0f}".format(result.dcf.fcf) }}</span>
                            </li>
                            <li class="d-flex justify-content-between mb-2">
                                <span>CAGR Hist: <i class="bi bi-info-circle info-icon ms-1" data-bs-toggle="tooltip" title="Średnioroczny wzrost przychodów w przeszłości."></i></span> 
                                <span class="font-monospace fw-bold">{{ result.dcf.cagr_raw }}%</span>
                            </li>
                            <li class="d-flex justify-content-between mb-2">
                                <span>Growth Used: <i class="bi bi-info-circle info-icon ms-1" data-bs-toggle="tooltip" title="Przyjęty wzrost na 5 lat (max 15%)."></i></span> 
                                <span class="font-monospace fw-bold text-blue">{{ result.dcf.growth }}%</span>
                            </li>
                            <li class="d-flex justify-content-between mb-2">
                                <span>WACC: <i class="bi bi-info-circle info-icon ms-1" data-bs-toggle="tooltip" title="Koszt kapitału (10%). Oczekiwana stopa zwrotu."></i></span> 
                                <span class="font-monospace fw-bold">{{ result.dcf.wacc }}%</span>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="dashboard-card text-center py-5">
                        <div class="metric-label-big">INTRINSIC VALUE <i class="bi bi-info-circle info-icon ms-1" data-bs-toggle="tooltip" title="Wartość wewnętrzna (prawdziwa) akcji wynikająca z przyszłych zysków, a nie spekulacji."></i></div>
                        <div class="display-3 fw-bold text-white">{{ result.dcf.fair_value }}</div>
                        <div class="text-secondary">PLN / akcję</div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <div id="view-fundamental" class="view-section">
            <h5 class="text-white mb-4">Analiza Wskaźnikowa</h5>
            <div class="row g-4">
                <div class="col-md-3">
                    <div class="dashboard-card h-100">
                        <h6 class="text-blue text-uppercase fw-bold mb-3">Rentowność</h6>
                        <div class="metric-item">
                            <span class="metric-name">ROE <i class="bi bi-info-circle info-icon" data-bs-toggle="tooltip" title="Zwrot z kapitału. >10%"></i></span>
                            <span class="metric-val {{ 'val-good' if result.latest.ROE > 10 else 'val-bad' }}">{{ "{:.1f}".format(result.latest.ROE) }}%</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-name">ROA <i class="bi bi-info-circle info-icon" data-bs-toggle="tooltip" title="Zwrot z aktywów. >5%"></i></span>
                            <span class="metric-val">{{ "{:.1f}".format(result.latest.ROA) }}%</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-name">ROS <i class="bi bi-info-circle info-icon" data-bs-toggle="tooltip" title="Marża netto. Im wyżej tym lepiej."></i></span>
                            <span class="metric-val">{{ "{:.1f}".format(result.latest.ROS) }}%</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="dashboard-card h-100 border-neon-pink">
                        <h6 class="text-pink text-uppercase fw-bold mb-3">Forensic Analytics</h6>
                        <div class="metric-item">
                            <span class="metric-name">F-Score <i class="bi bi-info-circle info-icon" data-bs-toggle="tooltip" title="Piotroski Score (0-9). >7 to wysoka wiarygodność."></i></span>
                            <span class="metric-val {% if result.f_score > 6 %}val-good{% else %}val-bad{% endif %}">{{ result.f_score }}/9</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-name">Z-Score <i class="bi bi-info-circle info-icon" data-bs-toggle="tooltip" title="Model Altmana. <1.81 ryzyko upadłości."></i></span>
                            <span class="metric-val">{{ "{:.2f}".format(result.latest.Z_Score_Val) }}</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="dashboard-card h-100">
                        <h6 class="text-blue text-uppercase fw-bold mb-3">Forensic</h6>
                        <div class="metric-item">
                            <span class="metric-name">Z-Score <i class="bi bi-info-circle info-icon" data-bs-toggle="tooltip" title="<1.8 Bankructwo, >2.99 Bezpiecznie"></i></span>
                            <span class="metric-val {{ 'val-good' if result.latest.Z_Score_Val > 2.99 else 'val-bad' }}">{{ "{:.2f}".format(result.latest.Z_Score_Val) }}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-name">F-Score <i class="bi bi-info-circle info-icon" data-bs-toggle="tooltip" title="Piotroski Score (0-9). >7 Silne fundamenty."></i></span>
                            <span class="metric-val {{ 'val-good' if result.f_score > 6 else 'val-bad' }}">{{ result.f_score }}/9</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="dashboard-card h-100 p-0 overflow-auto" style="max-height: 250px;">
                        <table class="table table-dark table-sm mb-0 small text-center">
                            <thead><tr><th>Rok</th><th>Zysk</th><th>Z-Score</th></tr></thead>
                            <tbody>
                                {% for row in result.history %}
                                <tr>
                                    <td>{{ row.Rok }}</td>
                                    <td class="{{ 'text-success' if row.Zysk_Netto > 0 else 'text-danger' }}">{{ "{:,.0f}".format(row.Zysk_Netto/1000000) }}</td>
                                    <td>{{ "{:.2f}".format(row.Z_Score_Val) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-indicators" class="view-section">
            <h5 class="text-white mb-4">Wskaźniki Finansowe (Dane Kwartalne vs Roczne)</h5>
            
            <ul class="nav nav-tabs" id="indicatorTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="liquidity-tab" data-bs-toggle="tab" data-bs-target="#liquidity-content" type="button" role="tab" aria-controls="liquidity-content" aria-selected="true">Płynność</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="debt-tab" data-bs-toggle="tab" data-bs-target="#debt-content" type="button" role="tab" aria-controls="debt-content" aria-selected="false">Zadłużenie</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="profitability-tab" data-bs-toggle="tab" data-bs-target="#profitability-content" type="button" role="tab" aria-controls="profitability-content" aria-selected="false">Rentowność</button>
                </li>
            </ul>

            <div class="tab-content" id="indicatorTabsContent">
                <!-- Płynność -->
                <div class="tab-pane fade show active" id="liquidity-content" role="tabpanel">
                    <div class="dashboard-card mt-3 p-0">
                        <table class="table table-dark table-sm mb-0 small">
                            <thead class="text-secondary">
                                <tr>
                                    <th class="ps-3">Wskaźnik</th>
                                    {% for row in result.history_quarterly|slice(0, 4) %}<th class="text-center">{{ row.index }}</th>{% endfor %}
                                    <th class="bg-secondary text-white text-center">Roczne -></th>
                                    {% for row in result.history_annual|slice(0, 4) %}<th class="text-center">{{ row.Rok }}</th>{% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="ps-3 fw-bold">Current Ratio</td>
                                    {% for row in result.history_quarterly|slice(0, 4) %}<td class="text-center font-monospace">{{ "%.2f"|format(row.Current_Ratio) }}</td>{% endfor %}
                                    <td class="bg-secondary"></td>
                                    {% for row in result.history_annual|slice(0, 4) %}<td class="text-center font-monospace">{{ "%.2f"|format(row.Current_Ratio) }}</td>{% endfor %}
                                </tr>
                                <tr>
                                    <td class="ps-3 fw-bold">Quick Ratio</td>
                                    {% for row in result.history_quarterly|slice(0, 4) %}<td class="text-center font-monospace">{{ "%.2f"|format(row.Quick_Ratio) }}</td>{% endfor %}
                                    <td class="bg-secondary"></td>
                                    {% for row in result.history_annual|slice(0, 4) %}<td class="text-center font-monospace">{{ "%.2f"|format(row.Quick_Ratio) }}</td>{% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Zadłużenie -->
                <div class="tab-pane fade" id="debt-content" role="tabpanel">
                    <div class="dashboard-card mt-3 p-0">
                        <table class="table table-dark table-sm mb-0 small">
                            <thead class="text-secondary">
                                <tr>
                                    <th class="ps-3">Wskaźnik</th>
                                    {% for row in result.history_quarterly|slice(0, 4) %}<th class="text-center">{{ row.index }}</th>{% endfor %}
                                    <th class="bg-secondary text-white text-center">Roczne -></th>
                                    {% for row in result.history_annual|slice(0, 4) %}<th class="text-center">{{ row.Rok }}</th>{% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="ps-3 fw-bold">Debt Ratio</td>
                                    {% for row in result.history_quarterly|slice(0, 4) %}<td class="text-center font-monospace">{{ "%.2f"|format(row.Debt_Ratio) }}</td>{% endfor %}
                                    <td class="bg-secondary"></td>
                                    {% for row in result.history_annual|slice(0, 4) %}<td class="text-center font-monospace">{{ "%.2f"|format(row.Debt_Ratio) }}</td>{% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Rentowność -->
                <div class="tab-pane fade" id="profitability-content" role="tabpanel">
                    <div class="dashboard-card mt-3 p-0">
                        <table class="table table-dark table-sm mb-0 small">
                            <thead class="text-secondary">
                                <tr>
                                    <th class="ps-3">Wskaźnik (%)</th>
                                    {% for row in result.history_quarterly|slice(0, 4) %}<th class="text-center">{{ row.index }}</th>{% endfor %}
                                    <th class="bg-secondary text-white text-center">Roczne -></th>
                                    {% for row in result.history_annual|slice(0, 4) %}<th class="text-center">{{ row.Rok }}</th>{% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="ps-3 fw-bold">ROE</td>
                                    {% for row in result.history_quarterly|slice(0, 4) %}<td class="text-center font-monospace">{{ "%.1f"|format(row.ROE) }}%</td>{% endfor %}
                                    <td class="bg-secondary"></td>
                                    {% for row in result.history_annual|slice(0, 4) %}<td class="text-center font-monospace">{{ "%.1f"|format(row.ROE) }}%</td>{% endfor %}
                                </tr>
                                <tr>
                                    <td class="ps-3 fw-bold">ROA</td>
                                    {% for row in result.history_quarterly|slice(0, 4) %}<td class="text-center font-monospace">{{ "%.1f"|format(row.ROA) }}%</td>{% endfor %}
                                    <td class="bg-secondary"></td>
                                    {% for row in result.history_annual|slice(0, 4) %}<td class="text-center font-monospace">{{ "%.1f"|format(row.ROA) }}%</td>{% endfor %}
                                </tr>
                                <tr>
                                    <td class="ps-3 fw-bold">ROS</td>
                                    {% for row in result.history_quarterly|slice(0, 4) %}<td class="text-center font-monospace">{{ "%.1f"|format(row.ROS) }}%</td>{% endfor %}
                                    <td class="bg-secondary"></td>
                                    {% for row in result.history_annual|slice(0, 4) %}<td class="text-center font-monospace">{{ "%.1f"|format(row.ROS) }}%</td>{% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-charts" class="view-section">
            <h5 class="text-white mb-4">Wykresy Analityczne</h5>
            <div class="row g-4">
                <div class="col-md-6"><div class="dashboard-card p-0"><img src="data:image/png;base64,{{ result.charts.z_score }}" class="chart-img"></div></div>
                <div class="col-md-6"><div class="dashboard-card p-0"><img src="data:image/png;base64,{{ result.charts.prof }}" class="chart-img"></div></div>
                <div class="col-md-6"><div class="dashboard-card p-0"><img src="data:image/png;base64,{{ result.charts.liq }}" class="chart-img"></div></div>
                <div class="col-md-6"><div class="dashboard-card p-0"><img src="data:image/png;base64,{{ result.charts.benford }}" class="chart-img"></div></div>
            </div>
        </div>

    </div>
    {% endif %}

    <div id="view-subscription" class="view-section container px-4">
        <h2 class="text-white fw-bold text-center mb-5">Plany Abonamentowe</h2>
        <div class="row g-4 justify-content-center">
            <div class="col-md-4">
                <div class="pricing-card">
                    <h4 class="text-secondary">STARTER</h4>
                    <div class="price-tag">0 zł<span class="price-period">/mc</span></div>
                    <ul class="list-unstyled text-dim mb-4 small text-start ps-4">
                        <li class="mb-2 text-white"><i class="bi bi-check-lg me-2 text-blue"></i> 500 analiz dziennie</li>
                        <li class="mb-2"><i class="bi bi-check-lg me-2 text-blue"></i> Podstawowe wskaźniki</li>
                    </ul>
                    <button class="btn btn-outline-light w-100">Twój Plan</button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="pricing-card" style="border-color: var(--accent-blue); background: rgba(41, 98, 255, 0.05);">
                    <h4 class="text-blue">INVESTOR</h4>
                    <div class="price-tag">49 zł<span class="price-period">/mc</span></div>
                    <ul class="list-unstyled text-dim mb-4 small text-start ps-4">
                        <li class="mb-2 text-white"><i class="bi bi-check-lg me-2 text-blue"></i> Bez limitu</li>
                        <li class="mb-2 text-white"><i class="bi bi-check-lg me-2 text-blue"></i> Pełny Raport DCF</li>
                    </ul>
                    <button class="btn btn-primary w-100">Wybierz</button>
                </div>
            </div>
        </div>
    </div>

    <div id="view-login" class="view-section container px-4" style="margin-top: 50px;">
        
        {% if current_user.is_authenticated %}
        <div class="dashboard-card text-center" style="max-width: 500px; margin: 0 auto;">
            <h1 class="text-success mb-3"><i class="bi bi-person-check-fill"></i></h1>
            <h4 class="text-white">Witaj, {{ current_user.email }}</h4>
            <p class="text-dim">Twój plan: <span class="badge bg-primary text-uppercase">{{ current_user.plan }}</span></p>
            <p class="text-dim">Masz nielimitowany dostęp do analiz.</p>
            <a href="/logout" class="btn btn-outline-danger mt-3">Wyloguj się</a>
        </div>

        {% else %}
        <div class="row g-4 justify-content-center">
            
            <div class="col-md-5">
                <div class="dashboard-card h-100">
                    <h4 class="text-center text-white mb-4">Zaloguj się</h4>
                    <form action="/login" method="POST">
                        <div class="mb-3">
                            <label class="text-dim small mb-1">EMAIL</label>
                            <input type="email" name="email" class="form-control form-control-dark" required>
                        </div>
                        <div class="mb-4">
                            <label class="text-dim small mb-1">HASŁO</label>
                            <input type="password" name="password" class="form-control form-control-dark" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">WEJDŹ</button>
                    </form>
                </div>
            </div>

            <div class="col-md-5">
                <div class="dashboard-card h-100" style="border-color: var(--text-dim);">
                    <h4 class="text-center text-white mb-4">Załóż Konto</h4>
                    <form action="/register" method="POST">
                        <div class="mb-3">
                            <label class="text-dim small mb-1">EMAIL</label>
                            <input type="email" name="email" class="form-control form-control-dark" required>
                        </div>
                        <div class="mb-4">
                            <label class="text-dim small mb-1">HASŁO</label>
                            <input type="password" name="password" class="form-control form-control-dark" required>
                        </div>
                        <button type="submit" class="btn btn-outline-light w-100">ZAREJESTRUJ SIĘ</button>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
    function openNav() { document.getElementById("mySidebar").style.width = "240px"; document.getElementById("main-content").style.marginLeft = "240px"; }
    function closeNav() { document.getElementById("mySidebar").style.width = "0"; document.getElementById("main-content").style.marginLeft= "0"; }
    function showSection(sectionId) {
        document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
        document.getElementById('view-' + sectionId).style.display = 'block';
        document.querySelectorAll('.sidebar a').forEach(el => el.classList.remove('active'));
        if(document.getElementById('link-' + sectionId)) { document.getElementById('link-' + sectionId).classList.add('active'); }
        if (window.innerWidth < 768) closeNav();
    }
</script>
<script>
    // This script is for the navigation search bar
    const navInput = document.getElementById('navTickerInput');
    const navSuggBox = document.getElementById('navSuggestionsBox');
    let navDebounceTimer;

    if (navInput) {
        navInput.addEventListener('input', () => {
            clearTimeout(navDebounceTimer);
            const query = navInput.value.trim().toUpperCase();
            
            if (query.length < 2) {
                if(navSuggBox) navSuggBox.style.display = 'none';
                return;
            }

            navDebounceTimer = setTimeout(async () => {
                try {
                    const response = await fetch(`/search_suggestions?q=${query}`);
                    const data = await response.json();
                    
                    if (navSuggBox && data.suggestions && data.suggestions.length > 0) {
                        navSuggBox.innerHTML = data.suggestions.map(s => `
                            <div class="suggestion-item" onclick="selectNavTicker('${s.symbol}')">
                                <span class="symbol-highlight">${s.symbol}</span> 
                                <span class="name-dim ms-2">${s.name}</span>
                            </div>
                        `).join('');
                        navSuggBox.style.display = 'block';
                    } else {
                        if(navSuggBox) navSuggBox.style.display = 'none';
                    }
                } catch (err) {
                    console.error("Błąd pobierania sugestii.", err);
                }
            }, 300);
        });
    }

    function selectNavTicker(sym) {
        if(navInput) navInput.value = sym;
        if(navSuggBox) navSuggBox.style.display = 'none';
        const navForm = document.getElementById('navSearchForm');
        if(navForm) navForm.submit();
    }

    // Close suggestions when clicking outside
    document.addEventListener('click', (e) => {
        const searchContainer = e.target.closest('.search-container-nav');
        if (navSuggBox && !searchContainer) {
            navSuggBox.style.display = 'none';
        }
    });
</script>
</body>
<style>
    .toast-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 99999;
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: none; /* Żeby nie blokowało klikania pod spodem */
    }

    .custom-alert {
        pointer-events: auto; /* Dymek można kliknąć */
        padding: 12px 24px;
        border-radius: 50px; /* Nowoczesny kształt */
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        font-size: 15px;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        gap: 10px;
        border: 1px solid rgba(255,255,255,0.1);
        backdrop-filter: blur(8px);
        
        /* Stan początkowy */
        opacity: 0; 
        transform: translateY(-20px);
        animation: slideIn 0.4s forwards;
    }

    .alert-error { background: rgba(239, 68, 68, 0.95); } /* Czerwony */
    .alert-success { background: rgba(34, 197, 94, 0.95); } /* Zielony */

    /* Animacja wjazdu */
    @keyframes slideIn {
        to { opacity: 1; transform: translateY(0); }
    }

    /* Klasa dodawana przez JS do znikania */
    .hide-toast {
        opacity: 0 !important;
        transform: translateY(-20px) !important;
        transition: all 0.5s ease-in-out;
    }
</style>

<div id="notification-area" class="toast-container">
    {% if error %}
    <div class="custom-alert alert-error">
        <span>⚠️</span>
        <span>{{ error }}</span>
    </div>
    {% endif %}

    {% if msg %}
    <div class="custom-alert alert-success">
        <span>✅</span>
        <span>{{ msg }}</span>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // 1. Znajdź wszystkie dymki (niezależnie od spacji w HTML)
        const alerts = document.querySelectorAll('.custom-alert');

        if (alerts.length > 0) {
            // 2. Czekaj 3.5 sekundy
            setTimeout(() => {
                alerts.forEach(alert => {
                    // 3. Dodaj klasę, która wymusza zanikanie
                    alert.classList.add('hide-toast');
                });

                // 4. Usuń całkowicie z HTML po zakończeniu animacji (0.5s później)
                setTimeout(() => {
                    const container = document.getElementById('notification-area');
                    if(container) container.innerHTML = '';
                }, 500);

            }, 3500);
        }
    });
</script>
</html>